# PostgreSQL 17 - Production Baseline (Template)
# Date: 2025-12-14
#
# Purpose:
# - Provide a safe starting point that works for most production workloads.
# - Tune further based on measured workload (connections, query patterns, DB size, I/O).
#
# How to apply (Ubuntu packaging):
# 1) Copy to: /etc/postgresql/17/main/conf.d/production.conf
# 2) Validate: sudo -u postgres psql -c "SELECT pg_reload_conf();" (for reloadable params)
# 3) Restart Postgres for non-reloadable params (e.g., shared_buffers, shared_preload_libraries).
#
# IMPORTANT:
# - Avoid over-allocating memory (especially work_mem) without understanding concurrency.
# - If Postgres is local-only, keep listen_addresses='localhost' and restrictive pg_hba.conf.

#------------------------------------------------------------------------------
# CONNECTIONS
#------------------------------------------------------------------------------
# Use PgBouncer if you expect high connection churn or many clients.
max_connections = 200
superuser_reserved_connections = 3

#------------------------------------------------------------------------------
# MEMORY (start conservative; scale up after measuring)
#------------------------------------------------------------------------------
# For very large-RAM hosts, "25% of RAM" is not always optimal; start lower and measure.
shared_buffers = 16GB
effective_cache_size = 128GB

# Per sort/hash operation; high values can OOM when many sessions sort concurrently.
work_mem = 16MB

maintenance_work_mem = 1GB
huge_pages = try

# Leave WAL buffers to auto-tuning unless you have evidence to change it.
wal_buffers = -1

#------------------------------------------------------------------------------
# WAL / CHECKPOINTS
#------------------------------------------------------------------------------
checkpoint_completion_target = 0.9
max_wal_size = 16GB
min_wal_size = 1GB
wal_compression = on

#------------------------------------------------------------------------------
# I/O / PLANNER
#------------------------------------------------------------------------------
# SSD-friendly defaults; verify with your storage.
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

#------------------------------------------------------------------------------
# PARALLELISM
#------------------------------------------------------------------------------
max_worker_processes = 16
max_parallel_workers = 16
max_parallel_workers_per_gather = 4
max_parallel_maintenance_workers = 4

#------------------------------------------------------------------------------
# LOGGING / OBSERVABILITY
#------------------------------------------------------------------------------
# On systemd hosts, stderr â†’ journald is often sufficient; enable collector only if needed.
log_destination = 'stderr'
logging_collector = off

log_line_prefix = '%m [%p] %u@%d %r '
log_min_duration_statement = 1000
log_checkpoints = on
log_lock_waits = on
log_temp_files = 0

#------------------------------------------------------------------------------
# EXTENSIONS (recommended)
#------------------------------------------------------------------------------
# Requires restart.
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.track = all
pg_stat_statements.max = 10000
pg_stat_statements.save = on

#------------------------------------------------------------------------------
# SECURITY
#------------------------------------------------------------------------------
password_encryption = scram-sha-256
ssl = on
ssl_min_protocol_version = 'TLSv1.2'

#------------------------------------------------------------------------------
# REPLICATION (optional)
#------------------------------------------------------------------------------
# wal_level = replica
# max_wal_senders = 3
# wal_keep_size = 1GB
