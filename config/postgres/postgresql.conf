# =============================================================================
# PostgreSQL Configuration - Optimized for Casino Backend
# Server: AMD Ryzen 9 9950X (16 cores/32 threads), 186GB RAM, NVMe SSD
# =============================================================================

# -----------------------------------------------------------------------------
# CONNECTION SETTINGS
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 500
superuser_reserved_connections = 5

# -----------------------------------------------------------------------------
# MEMORY SETTINGS (Server has 186GB RAM, PostgreSQL allocated 32GB in Docker)
# -----------------------------------------------------------------------------
shared_buffers = 8GB                    # 25% of container memory
effective_cache_size = 24GB             # 75% of container memory
work_mem = 64MB                         # Per-operation memory
maintenance_work_mem = 2GB              # For VACUUM, CREATE INDEX
huge_pages = try                        # Use huge pages if available

# -----------------------------------------------------------------------------
# WAL SETTINGS (Critical for write performance)
# -----------------------------------------------------------------------------
wal_level = replica
wal_buffers = 64MB
max_wal_size = 4GB
min_wal_size = 1GB
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min

# For NVMe SSD - enable faster fsync
synchronous_commit = on
wal_compression = on
wal_writer_delay = 200ms

# -----------------------------------------------------------------------------
# QUERY PLANNER
# -----------------------------------------------------------------------------
random_page_cost = 1.1                  # SSD: nearly same as seq scan
effective_io_concurrency = 200          # NVMe can handle high concurrency
default_statistics_target = 100

# -----------------------------------------------------------------------------
# PARALLEL QUERY (Use 8 cores for parallel operations)
# -----------------------------------------------------------------------------
max_worker_processes = 16
max_parallel_workers_per_gather = 8
max_parallel_workers = 16
max_parallel_maintenance_workers = 4
parallel_tuple_cost = 0.01
parallel_setup_cost = 100

# -----------------------------------------------------------------------------
# AUTOVACUUM (Aggressive for high-write casino workload)
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 30s
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 2ms
autovacuum_vacuum_cost_limit = 1000

# -----------------------------------------------------------------------------
# LOGGING
# -----------------------------------------------------------------------------
logging_collector = on
log_directory = 'pg_log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_min_duration_statement = 1000       # Log queries > 1 second
log_checkpoints = on
log_connections = off                   # Too noisy for high traffic
log_disconnections = off
log_lock_waits = on
log_statement = 'ddl'
log_temp_files = 0

# -----------------------------------------------------------------------------
# NETWORK
# -----------------------------------------------------------------------------
tcp_keepalives_idle = 60
tcp_keepalives_interval = 10
tcp_keepalives_count = 10

# -----------------------------------------------------------------------------
# LOCALE
# -----------------------------------------------------------------------------
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'

# -----------------------------------------------------------------------------
# TIMEZONE
# -----------------------------------------------------------------------------
timezone = 'UTC'
